## 为什么要做单元测试？

单元测试是理想测试金字塔里最底层的自动化测试，相比于其他高层自动化测试，依赖的外部环境少、耗时短，同时也是最贴近代码的测试，因此是保证测试质量、代码正确性不可或缺的一个环节。

### 单元测试是什么？

单元测试是用来对一个模块、一个函数或者一个类来进行正确性检验的测试工作。

### 单元测试的收益？

增强研发人员对代码修改重构的信心，在开发阶段运行单测时就可以暴露出问题，减少联调测试成本，同时单元测试伴随代码生命周期的始终，是最好的开发文档，永不过时。

### 单元测试的编写原则？

可以总结以下几条原则。首先，要**足够快**，以便于快速反馈出系统健康程度。其次**隔离性**，不同的单测应相互隔离，可以以任何顺序运行。并且具有**幂等** **性**，每个单测应当在每一次运行时产生与之前的一样的结果。最后需要**自动化**，测试结果需要程序能直接判断，不需要人工介入。

### 单元测试如何编写？

一个三步经典结构：准备，调用，断言。准备，准备好调⽤所需要的外部环境，如数据，临时变量等等。调⽤，实际调⽤需要测试⽅法，函数或者流程。断⾔，判断调⽤部分的返回结果是否符合预期。

### 单元测试有什么常见误区？

误区1：测试用例设计基于实现，过多的考虑中间实现逻辑，会使得测试 case 非常脆弱，在重构随时都有的情况下，更建议**基于意图**，思考被测试的单元最终目的，不考虑中间生成了哪些临时变量、循环了几次，比如排序函数关心排序后的结果是否符合预期，不关心内部是归并排序还是快速排序。

误区2：盲目追求覆盖率 100%，会导致大量增加编码成本，应遵循热点原则，优先编写核心组件和逻辑模块的测试用例，在有限的时间内，寻求收益较大化。

## Go 单元测试如何运行？

使用 `go test` 运行单元测试，也可以通过指定参数输出详细结果、输出覆盖率、运行特定的测试用例等， 参考 `go test testflag`

想要以html形式查看代码哪行没覆盖，就可以运行以下命令
```bush
go test ./... -coverprofile=cover.out

go tool cover -html=cover.out
```
### 对于 RPC 等外部依赖的代码如何写单元测试？

外部依赖如 RPC 等可能存在着不稳定、时延不可控、数据互相干扰的问题，干扰单元测试的测试原则。那我们可以**引入 Mock，** 伪造输入依赖和验证输出依赖，来解决外部依赖问题。

再有了 Mock 之后，注意不要滥用 Mock, 对于一些不干扰整体测试原则的外部依赖，比如一个 md5 函数，我们应尽量用测试用例去覆盖，干扰测试原则的再 Mock, 因为Mock也是会增加编码成本的，同时不 Mock 也更加符合代码真实使用场景。

这里推荐个开源的 Mock 框架: Monkey, 它可以快速 Mock 一个函数，为一个函数或者方法打桩，使用 API 也比较简单。

### 特殊的外部存储依赖

有了 Mock，我们可解决一切外部依赖问题，但有时可能确实有诉求想验证和存储交互代码的正确性，比如 Redis 的命令使用是否正确等。那我们可以通过 **Docker** **容器**来解决，比如 Mysql、Redis、Mongo 外部依赖存储等都可以快速启动，通过 Mock 把代码中与实际存储的连接指向到 Docker 容器中，我们就有了一个完整而又相互隔离的外部存储测试环境啦！当然在一个测试 case 中，对测试存储中写入的数据在结束这个测试 case 时记得要删除，避免影响单元测试的隔离性。

### Go 单元测试框架技术选型

开源的测试框架主要有 gomock 、monkey 等 Mock 框架，以及 testify、goconvey、ginkgo 等断言框架，至于如何选择就“仁者见仁，智者见智”了。

对于面向对象写法的研发人员，建议使用 gomock；对于非面向对象写法、Mock 能力所需也比较简单的研发人员，更建议使用 monkey。

### 为什么要推动 CI 集成？

研发作为一个团体协作的工种，通过 CI 集成帮助大家从“个人写好单测” 过渡到 “团队写好单元”，是团队单测落地的必经路径。

我们可以通过 CI 对代码单测覆盖率进行卡点，比如 Gitlab CI 就可以引入 codecov 的工具来实现。在团队单元测试落地的过程中，建议落实 Code Review，这会是个以老带新、互相监督、互相学习如何写好单测的好方法。

## 📒 课件

- [**点击此处，查看本节课件**](https://bytedance.feishu.cn/file/boxcnj8NPF1yIF0chHf53ZwEbve?from=from_copylink "https://bytedance.feishu.cn/file/boxcnj8NPF1yIF0chHf53ZwEbve?from=from_copylink")

## 推荐资料

- [_How to add a test_](https://link.juejin.cn/?target=https%3A%2F%2Fgolang.org%2Fdoc%2Ftutorial%2Fadd-a-test "https://golang.org/doc/tutorial/add-a-test")
- [_gomock_](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fgolang%2Fmock "https://github.com/golang/mock")
- [_monkey_](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fbouk%2Fmonkey "https://github.com/bouk/monkey")